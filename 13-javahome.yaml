---
- name: Ensure Java is installed and JAVA_HOME is set
  hosts: g2
  become: yes
  tasks:
    - name: Install OpenJDK
      amazon_linux_extras:
        name: java-openjdk11
        state: present

    - name: Find Java installation path
      command: readlink -f $(which java)
      register: java_path

    - name: Create JAVA_HOME environment file
      copy:
        dest: /etc/profile.d/java.sh
        content: |
          # Set JAVA_HOME
          export JAVA_HOME={{ java_path.stdout | dirname | dirname }}
        mode: '0644'
        owner: root
        group: root

    - name: Ensure profile.d scripts are sourced
      command: source /etc/profile.d/java.sh
      environment:
        JAVA_HOME: "{{ java_path.stdout | dirname | dirname }}"

    - name: Verify JAVA_HOME
      command: echo $JAVA_HOME
      register: java_home_check

    - name: Print JAVA_HOME value
      debug:
        msg: "JAVA_HOME is set to {{ java_home_check.stdout }}"
...